{% load static %}
<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="{% static 'bootstrap/css/bootstrap.min.css' %}"
    integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

  <title>{% block title %}{% endblock title %}</title>
</head>

<body>
  {% include "navbar.html" %}
  
  <div class="container">

    {% block content %}
    {% endblock content %}
  </div>
  {% include "reply-modal.html" %}
  <!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <!-- <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script> -->

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script>function getParameterByName(name, url) {
      if (!url) url = window.location.href;
      name = name.replace(/[\[\]]/g, '\\$&');
      var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
        results = regex.exec(url);
      if (!results) return null;
      if (!results[2]) return '';
      return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }
    function loadTweetContainer(tweetContainerID, fetchOneId) {
      var query = getParameterByName('q')
      var tweetList = [];
      var nextTweetUrl;

      var tweetContainer;
      if (tweetContainerID) {
        tweetContainer = $("#" + tweetContainerID)
      }
      else {
        tweetContainer = $("#tweet-container")
      }
      var initialUrl = tweetContainer.attr("data-url") || "/api/tweet/"
      console.log("initialUrl")
      console.log(initialUrl)
      $(document.body).on("click",".tweet-like", function(e){
        e.preventDefault()
        console.log("Reaching Ajax")
        var this_ = $(this)
        var tweetId = this_.attr("data-id")
        console.log(tweetId)
        var likedUrl = "/api/tweet/"+tweetId+"/like/"

        $.ajax({
          method:"GET",
          url: likedUrl,
          success: function(data){
            if(data.liked){
              this_.text("Liked")
            }
            else{
              this_.text("Unliked")
            }
          },
          error: function(data){
            console.log("error")
            console.log(data)

          }
        })
        // this_.text("Liked")
      })
      $(document.body).on("click", ".retweetBtn", function (e) {
        e.preventDefault()
        console.log("Clicked")
        var url = "/api" + $(this).attr("href")
        console.log(url)
        $.ajax({
          method: "GET",
          url: url,
          success: function (data) {
            console.log(data)
            if (initialUrl == "/api/tweet/") {
              attachTweet(data, true, true)
              updateHashLinks()

            }

          },
          error: function (data) {
            console.log("error")
            console.log(data)
          }
        })
      })
      $(document.body).on("click", ".tweet-reply", function (e) {
        e.preventDefault()
        console.log("Entering Reply")
        var this_ = $(this)
        var parentId = this_.attr("data-id")
        var username = this_.attr("data-user")
        console.log(username)
        $("#replyModal").modal({})
        $("#replyModal textarea").val("@"+username+" ")
        $("#replyModal textarea").after("<input type='hidden' value= '"+parentId+"' name = 'parent_id'/>")
        $("#replyModal textarea").after("<input type='hidden' value= '"+true+"' name = 'reply'/>")
        $("#replyModal textarea").on("shown.bs.modal", function(){
          $("textarea").focus()
        })
        // console.log("Clicked")
        // var url = "/api/" + $(this).attr("href")
        // $.ajax({
        //   method: "GET",
        //   url: url,
        //   success: function (data) {
        //     console.log(data)
        //     if (initialUrl == "/api/tweet/") {
        //       attachTweet(data, true, true)
        //       updateHashLinks()

        //     }

        //   },
        //   error: function (data) {
        //     console.log("error")
        //     console.log(data)
        //   }
        // })
      })
      function updateHashLinks() {
        $(".media-body").each(function (data) {
          //data.preventDefault()
          // console.log(this)
          var hashtagRegex = /(^|\s)#([\w\d-]+)/g
          var usernameRegex = /(^|\s)@([\w\d-]+)/g
          var currentHtml = $(this).html()
          console.log("currentHtml")
          console.log(currentHtml)
          var newText = currentHtml.replace(usernameRegex, '$1@<a href="profiles/$2/">$2</a>')
          console.log("newHtml")
          console.log(newText)
          var newText = newText.replace(hashtagRegex, '$1<a href="/tags/$2/">#$2</a>')
          $(this).html(newText)
        })

      }
      function formatTweet(tweetvalue){
        console.log("value")
        console.log(tweetvalue)
        var verb = 'Like'
        var tweetContent;
        var isReply = tweetvalue.reply
        if (tweetvalue.did_like){
          verb = 'Unlike'
        }
        var retweet="";
        console.log("isReply")
        console.log(isReply)
        console.log("typeof")
        console.log(typeof(tweetvalue.parent))
        if (tweetvalue.parent && !isReply){
          value = tweetvalue.parent
          retweet = "<span class=\"text-muted\">Retweet via " + value.user.username + " on " + value.date_display + "</span><br/>"
        }
        else if (tweetvalue.parent && isReply){
          value = tweetvalue.parent
          retweet = "<span class=\"text-muted\">Reply to @" + value.user.username +"</span><br/>"
        }
        tweetContent = tweetvalue.content + "<br/> via " + "<a href='" + tweetvalue.user.url + "'>" + tweetvalue.user.username + "</a> | " + tweetvalue.date_display + " |" + "<a href='/tweet/" + tweetvalue.id + "'>View</a> | <a class = 'retweetBtn' href='/tweet/" + tweetvalue.id + "/retweet'>Retweet</a>  | <a href=\"#\", class = \"tweet-like\", data-id="+tweetvalue.id+">"+verb+"("+tweetvalue.likes+")</a> | <a href=\"#\", class = \"tweet-reply\" data-user='"+tweetvalue.user.username+"', data-id='"+tweetvalue.id+"''>Reply</a>"
        var container = "<div class=\"media\"><div class=\"media-body\">"+retweet+tweetContent+"</div></div></hr><br>"
        return container
      }
      function attachTweet(value, prepend, retweet) {
        // console.log("attachtweet")
        console.log("attachTweet")
        console.log(value)
        var tweetContent = value.content
        // console.log(tweetContent)
        var tweetUser = value.user
        var isRetweet = value.is_retweet
        var dateDisplay = value.date_display
        var tweetHtml;
        var verb = 'Like'
        if (value.did_like){
          verb = 'Unlike'
        }
        tweetHtml = formatTweet(value)
        if (prepend == true) {
          tweetContainer.prepend(tweetHtml)
        }
        else {
          tweetContainer.append(tweetHtml)
        }

      }
      function parseTweets() {
        if (tweetList == 0) {
          tweetContainer.text("No tweets currently found")
        }
        else {
          // console.log("Entering Loop")
          $.each(tweetList, function (key, value) {
            console.log("TweetList")
            console.log(tweetList)
            var tweetKey = key
            console.log("value orgin")
            console.log(value)
            console.log("typeof origin")
            console.log(typeof(value.parent))
            if (value.parent) {
              attachTweet(value, false, true)
            }
            else {
              attachTweet(value)
            }

            // console.log(key)
            // console.log(value.user)
            // console.log(value.content)


          })

        }
      }

      function fetchTweets(url) {
        // console.log("Fetching....")
        var fetchUrl;
        if (!url) {
          fetchUrl = initialUrl
        }
        else {
          fetchUrl = url
        }
        console.log("fetchUrl")
        console.log(fetchUrl)
        $.ajax({
          url: fetchUrl,
          data: {
            "q": query
          },
          method: "GET",
          success: function (data) {
            tweetList = data.results
            console.log(tweetList)
            if (data.next) {
              nextTweetUrl = data.next
            }
            else {
              $('#loadmore').css("display", "none")
            }

            parseTweets()
            updateHashLinks()
          },
          error: function (data) {
            console.log("error")
            console.log(data)
          }
        })
      }
      function fetchSingle(fetchOneId) {
        // console.log("Fetching....")
        var fetchDetailUrl = '/api/tweet/'+fetchOneId+"/";
        $.ajax({
          url: fetchDetailUrl,
          method: "GET",
          success: function (data) {
            console.log(data)
            tweetList = [data]
            // if (data.next) {
            //   nextTweetUrl = data.next
            // }
            // else {
            //   $('#loadmore').css("display", "none")
            // }

            parseTweets()
            updateHashLinks()
          },
          error: function (data) {
            console.log("error")
            console.log(data)
          }
        })
      }
      console.log("fetchOneId")
      console.log(fetchOneId)
      if(fetchOneId){
        fetchSingle(fetchOneId)
      }
      else{
        fetchTweets()
      }
      
      $('#loadmore').bind("click", function (event) {
        event.preventDefault()
        if (nextTweetUrl) {
          fetchTweets(nextTweetUrl)
        }
      })
      var charsStart = 140
      var charsCurrent = 0

      $(".tweet-form").append("<span class='tweetCharsLeft', style='margin-left:20px'>" + charsStart + "</span>")

      $(".tweet-form textarea").keyup(function (event) {
        // console.log(event.key,event.timeStamp)
        tweetValue = $(this).val()
        // console.log(tweetValue)
        charsCurrent = charsStart - tweetValue.length
        console.log(charsCurrent)
        $(this).parent().parent().parent().find("span.tweetCharsLeft").text(charsCurrent)
        // console.log(charsCurrent)
      })

      $(".tweet-form").submit(function (event) {
        event.preventDefault()
        var this_ = $(this)
        var formData = this_.serialize()
        // console.log(formData)
        // console.log(charsCurrent)
        if (charsCurrent >= 0) {
          // console.log("Inside the Loop")
          $.ajax({
            url: "/api/tweet/create/",
            data: formData,
            method: "POST",
            success: function (data) {

              this_.find("input[type=text],textarea").val("")
              //console.log(data)
              // fetchTweets()
              attachTweet(data, true)
              updateHashLinks()
              $("#replyModal").modal("hide")
              // fetchTweets()
            },
            error: function (data) {
              console.log("error")
              console.log(data.statusText)
              console.log(data.status)
            }
          })
        }

        else {
          console.log("The Tweet Length is Too Long")
        }
      })
    }
  </script>
  {% block script %}{% endblock script %}

  <script>
    $(document).ready(function () {
      // console.log("Search Event")
      var typingTimer;
      var doneInterval = 500;
      var searchInput = $("#navbar-search-form input[type=text]")
      var searchQuery;

      searchInput.keyup(function (event) {
        // console.log("event")
        // console.log(typingTimer)
        searchQuery = $(this).val()
        clearTimeout(typingTimer)
        // console.log("Two " + typingTimer)
        typingTimer = setTimeout(doneSearchTyping, doneInterval);
        // console.log(searchQuery)
        // console.log("________")
        // console.log(typingTimer)
      });
      searchInput.keydown(function (event) {
        // console.log(event.key)
        // console.log(typingTimer)
        // console.log("One " + typingTimer)
        clearTimeout(typingTimer)
        // console.log(typingTimer)
      })
      function doneSearchTyping() {
        if (searchQuery) {
          //do search
          // console.log(window.location.pathname)
          // if ((document.location.href).includes("tweet/search/"))
          // {
          //   var url = '?q=' + searchQuery
          // }
          // else{

          // }
          var url = '/search/?q=' + searchQuery
          console.log(url)
          document.location.href = url;

        }
      }
    });
  </script>
  <script src="{% static 'bootstrap/js/bootstrap.min.js' %}"
    integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI"
    crossorigin="anonymous"></script>
</body>

</html>